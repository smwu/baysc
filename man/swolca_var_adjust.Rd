% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/swolca_var_adjust.R
\name{swolca_var_adjust}
\alias{swolca_var_adjust}
\title{Post-processing variance adjustment}
\usage{
swolca_var_adjust(
  res,
  alpha = NULL,
  eta = NULL,
  mu0 = NULL,
  Sig0 = NULL,
  num_reps = 100,
  save_res = TRUE,
  save_path = NULL,
  adjust_seed = NULL
)
}
\arguments{
\item{res}{An object of class \code{"swolca"}, resulting from a call to \code{\link[=swolca]{swolca()}},
containing the unadjusted estimates.}

\item{alpha}{Hyperparameter for prior for class membership probabilities
\eqn{\pi}. Default is \code{NULL} and default values are used (see Details below).
If specified, must be (\code{K_max})x1.}

\item{eta}{Hyperparameter for prior for item consumption level probabilities
\eqn{\theta_{jk\cdot}} for each item \eqn{j} and class \eqn{k}, assumed to be
the same across classes. Default is \code{NULL} and default values are used (see
Details below). If specified, must be JxR, where J is the number of exposure
items and R is the maximum number of levels for the exposure.}

\item{mu0}{Mean hyperparameters for regression coefficients \eqn{\xi_{k\cdot}}
for each class \eqn{k}. Default is \code{NULL} and default values are used (see
Details below). If specified, must be a list of \code{K_max} vectors of dimension
Qx1, where Q is the number of regression covariates excluding latent class assignment.}

\item{Sig0}{Variance hyperparameters for regression coefficients
\eqn{\xi_{k\cdot}} for each class \eqn{k}. Default is \code{NULL} and default
values are used (see Details below). If specified, must be a list of \code{K_max}
QxQ matrices, where Q is the number of regression covariates excluding latent
class assignment.}

\item{num_reps}{Number of bootstrap replicates to use for the variance
adjustment estimate. Default is 100.}

\item{save_res}{Boolean specifying if results should be saved. Default = \code{TRUE}.}

\item{save_path}{String specifying directory and file name to save results,
e.g., "~/Documents/run". Default is \code{NULL}. If this is the same as the file
name specified in \code{\link[=swolca]{swolca()}}, the unadjusted results are overwritten with the
adjusted results.}

\item{adjust_seed}{Numeric seed for variance adjustment. Default is \code{NULL}.}
}
\value{
Returns an object \code{res} of class \code{"swolca"}, which includes all outputs from
\code{\link[=swolca]{swolca()}} as well as a list \code{estimates_adjust} containing:
\describe{
\item{\code{pi_red}}{Matrix of adjusted posterior samples for pi. Mx(K_red),
where M is the number of MCMC iterations after burn-in and thinning.}
\item{\code{theta_red}}{Array of adjusted posterior samples for theta. MxJx(K_red)xR}
\item{\code{xi_red}}{Array of adjusted posterior samples for xi. Mx(K_red)xQ}
\item{\code{pi_med}}{Vector of adjusted posterior median estimates for pi. (K_red)x1}
\item{\code{theta_med}}{Array of adjusted posterior median estimates for theta. px(K_red)xR}
\item{\code{xi_med}}{Matrix of adjusted posterior median estimates for xi. (K_red)xQ}
\item{\code{Phi_med}}{Vector of adjusted individual outcome probabilities. nx1}
\item{\code{c_all}}{Vector of final individual class assignments from \code{swolca()}. nx1}
\item{\code{pred_class_probs}}{Matrix of individual posterior class
probabilities from \code{swolca()}. nx(K_red)}
\item{\code{loglik_med}}{Vector of final indiviudal log-likehoods from \code{swolca()}. nx1}
}
The \code{runtime} output for \code{res} is also updated to include the runtime for the
variance adjustment in addition to the runtime for the main \code{swolca()} model.

If \code{save_res = TRUE} (default), the updated \code{res} object is saved as
\verb{[save_path]_swolca_results.RData}, overwriting the unadjusted results if the
file names are the same.
}
\description{
\code{swolca_var_adj} applies applies the post-processing variance adjustment after
a call to \code{\link[=swolca]{swolca()}} to correct for underestimation of posterior intervals.
}
\details{
\code{var_adjust} applies a post-processing variance adjustment that rescales the
variance to obtain correct coverage of posterior intervals, adapted from
Williams and Savitsky (2021). To obtain the rescaling, a sandwich-type
variance is estimated. To estimate the Hessian that composes the "bread" of
the sandwich, the mixture model is specified in Stan and the parameters are
converted to the unconstrained space. Bootstrap replicates are used to
estimate the covariance matrix that composes the "meat" of the sandwich.
If there are any rounding issues, the resulting matrices are mapped to the
nearest positive definite matrix. Next, the rescaling adjustment is derived
and applied to the parameters for all MCMC iterations. Finally, the adjusted
parameters are converted back to the constrained space and the posterior
median parameter estimates are recomputed, now with proper variance estimation.

To save results, set \code{save_res = TRUE} (default) and \code{save_path} to a string
that specifies both the location and the beginning of the file name
(e.g., "~/Documents/run"). The file name will have "_swolca_results.RData"
appended to it, overwriting the unadjusted results if the file names are the
same.

If hyperparameters are left as \code{NULL} (default), the following default
values are used. Let \eqn{K} refer to the final number of latent class
obtained from running \code{\link[=swolca]{swolca()}}, available at \code{res$estimates$K_red}.
For \eqn{\pi}, a Dirichlet prior with hyperparameter \eqn{\alpha = 1/K} for
each component. For \eqn{\theta_{jk\cdot}}, a Dirichlet prior with
hyperparameter  \eqn{\eta_j} equal to \code{rep(1, R_j)} where \code{R_j} is the number
of levels for exposure item j. If \code{R_j < R}, the remaining levels have
hyperparameter set to 0.01. This is done independently for each exposure item j
and is assumed to be the same across latent classes. For \eqn{\xi_{k\cdot}}, a
Multivariate Normal distribution with mean vector hyperparameter \eqn{\mu_0}
drawn from a Normal(0,1) hyperprior for each component, and variance matrix
hyperparameter \eqn{\Sigma_0} a diagonal matrix with diagonal components drawn
from InvGamma(shape=3.5, scale=6.25) distributions.

If the following warning message appears, please run the sampler for more
iterations as there is instability in the parameter estimates, usually in the
form of large positive or negative values for \eqn{\xi}):
"Error in svrVar(thetas, scale, rscales, mse = design$mse, coef = full) :
All replicates contained NAs".

When running the variance adjustment, the following warning messages may appear:
"the number of chains is less than 1; sampling not done" and
"In mrbweights(design$cluster, design$strata, design$fpc, ...) : Design is
sampled with replacement: only first stage used". These messages do not pose
an issue to the statistical validity of the methods and can be ignored.
}
\examples{
\dontrun{   
# Load simulated data and obtain relevant variables
data("sim_data")
data_vars <- sim_data
x_mat <- data_vars$X_data            # Categorical exposure matrix, nxJ
y_all <- c(data_vars$Y_data)         # Binary outcome vector, nx1
cluster_id <- data_vars$cluster_id   # Cluster indicators, nx1
stratum_id <- data_vars$true_Si      # Stratum indicators, nx1
sampling_wt <- data_vars$sample_wt   # Survey sampling weights, nx1
n <- dim(x_mat)[1]                   # Number of individuals

# Probit model only includes latent class
V_data <- NULL # Additional regression covariates
glm_form <- "~ 1"

# Run swolca
res <- swolca(x_mat = x_mat, y_all = y_all, sampling_wt = sampling_wt,
              cluster_id = cluster_id, stratum_id = stratum_id, V_data = V_data,
              run_sampler = "both", glm_form = glm_form, adapt_seed = 1,
              n_runs = 50, burn = 25, thin = 1, save_res = FALSE)
       
# Apply variance adjustment to posterior estimates
res_adjust <- swolca_var_adjust(res = res, num_reps = 100, save_res = FALSE, 
                                adjust_seed = 1)                        
}
}
\references{
Williams, M. R., & Savitsky, T. D. (2021). Uncertainty Estimation for
Pseudoâ€Bayesian Inference Under Complex Sampling. International Statistical
Review, 89(1), 72-107.
}
\seealso{
\code{\link[=swolca]{swolca()}}
}
